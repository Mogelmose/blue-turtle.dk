generator client {
  provider = "prisma-client-js"
  seed     = "bun prisma/seed.js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  REGULAR
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  hashedPassword  String
  role      Role     @default(REGULAR)
  image     String?
  sessionVersion Int @default(0)
  notifications Notification[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastSeenAt DateTime?
}

enum Category {
  REJSER
  SPILLEAFTEN
  JULEFROKOST
}

enum MetadataStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum LocationSource {
  EXIF
  VIDEO_META
  NONE
}

enum JobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum JobType {
  EXTRACT_METADATA
  CONVERT_HEIC
  GENERATE_VIDEO_PREVIEW
}

model Album {
  id           String   @id @default(cuid())
  name         String   @unique
  infoText     String?
  media        Media[]
  category     Category @default(REJSER)
  coverImage   String?
  latitude     Float?
  longitude    Float?
  locationName String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

model Media {
  id        String   @id @default(cuid())
  url       String
  storagePath String?
  convertedPath String?
  previewPath String?
  filename  String?
  originalName String?
  mimeType  String?
  sizeBytes Int?
  metadataStatus MetadataStatus @default(PENDING)
  capturedAt DateTime?
  locationAutoLat Float?
  locationAutoLng Float?
  locationSource LocationSource?
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  albumId   String
  createdAt DateTime @default(now())

  @@index([albumId])
  @@index([albumId, filename])
}

model Job {
  id        String   @id @default(cuid())
  type      JobType
  payload   Json
  status    JobStatus @default(PENDING)
  attempts  Int      @default(0)
  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type, status])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  message   String
  albumId   String?
  mediaId   String?
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, readAt])
}
